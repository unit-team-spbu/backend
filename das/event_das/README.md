# IT-Events Crawler

Данный документ содержит описание работы и информацию о развертке микросервиса-обертки для хранилища информации о мероприятиях

Название сервиса: `event_das`

Структура сервиса:

| Файл                       | Описание                                                         |
| -------------------------- | ---------------------------------------------------------------- |
| `event_das.py`             | Код микросервиса                                                 |
| `config.yml`               | Кофигурационный файл со строкой подключения к RabbitMQ и MongoDB |
| `run.sh`                   | Файд для запуска краулера из Docker контейнера                   |
| `requirements.txt`         | Верхнеуровневые зависимости                                      |
| `requirements.lock`        | Все зависимости (`pip freeze`)                                   |
| `Dockerfile`               | Описание сборки контейнера сервиса                               |
| `docker-compose.yml`       | Изолированная развертка сервиса вместе с (RabbitMQ, MongoDB)     |
| `docker-compose.local.yml` | Развертка заивисимостей для дебаггинга (RabbitMQ, MongoDB)       |
| `.rest`                    | Тесты взаимодействия с HTTP эндпоинтами микросервиса             |
| `README.md`                | Описание микросервиса                                            |

## API

### RPC

```
rpc.event_das.save_events(events)
```

Для меж сервисного взаимодействия

### HTTP

```rst
POST http://localhost:8000/events HTTP/1.1
Content-Type: application/json

[
  {
    "title": "Видео+Конференция 2020",
    "type": "Конференция",
    "isPaid": true,
    "isOnline": true,
    "location": "Москва, Россия",
    "startDate": "13/10/2020",
    "endDate": "14/10/2020",
    "description": "...",
    "meta": {
      "it_events_crawler": "18960"
    }
  }
]
```

Для прямого взаимодействия по HTTP, ручного тестирования

## Развертывание и запуск

### Локальный запуск

Для локального запуска микросервиса требуется запустить контейнер с RabbitMQ и MongoDB. Для этого есть специальный `docker-compose.local.yml`. Чтобы запустить:

```bat
docker-compose --file docker-compose.local.yml up -d
```

Затем из папки микросервиса вызвать

```bat
nameko run event_das
```

После чего можно проверить работоспособность сервиса через `.rest` файл (с расширением для VSCode/PyCharm), через Postman. Проверка таким образом производится по `http`.

Для проверки `rpc` запустите в командной строке:

```bat
nameko shell
```

После чего откроется интерактивная Python среда и обратитесь к сервису следующей командой:

```bat
n.rpc.event_das.save_events(<events>)
```

### Запуск в контейнере

Чтобы запустить микросервис в контейнере вызовите команду:

```bat
docker-compose up
```

> если вы не хотите просмотривать логи, добавьте флаг `-d` в конце

Микросервис запустится вместе с RabbitMQ и MongoDB в контейнерах.

> Во всех случаях запуска вместе с MongoDB также разворачивается mongo-express - инструмент, с помощью которого можно просматривать и изменять содержимое подключенной базы (подключение в контейнерах сконфигурировано и производится автоматически). Сервис хостится локально на порту 8081.
